---
# Node Exporter installation tasks
# Wraps the geerlingguy.node_exporter role with arch detection

- name: Include common role for arch detection
  ansible.builtin.include_role:
    name: common

- name: Set node_exporter architecture
  ansible.builtin.set_fact:
    node_exporter_arch: >-
      {%- if arch_armv7 -%}armv7
      {%- elif arch_arm64 -%}arm64
      {%- else -%}amd64
      {%- endif -%}

- name: Display node_exporter configuration
  ansible.builtin.debug:
    msg:
      - "Node Exporter Version: {{ node_exporter_version }}"
      - "Architecture: {{ node_exporter_arch }}"
      - "Listen Address: {{ node_exporter_host }}:{{ node_exporter_port }}"

- name: Include geerlingguy.node_exporter role
  ansible.builtin.include_role:
    name: geerlingguy.node_exporter

- name: Wait for node_exporter to be ready
  ansible.builtin.wait_for:
    host: "{{ node_exporter_host }}"
    port: "{{ node_exporter_port }}"
    delay: 2
    timeout: 30
    state: started
  when: node_exporter_host != 'localhost'

- name: Verify node_exporter is responding
  ansible.builtin.uri:
    url: "http://{{ node_exporter_host if node_exporter_host != '0.0.0.0' else 'localhost' }}:{{ node_exporter_port }}/metrics"
    method: GET
    status_code: 200
  register: metrics_check
  ignore_errors: true

- name: Display verification result
  ansible.builtin.debug:
    msg: "Node exporter is running and responding to metrics requests"
  when: metrics_check is success

# OTEL Collector installation (optional)
- name: Install OTEL Collector
  when: otel_host != "" and otel_token != ""
  block:
    - name: Set OTEL architecture string
      ansible.builtin.set_fact:
        otel_arch: "{{ 'linux_arm64' if arch_arm64 else 'linux_amd64' }}"

    - name: Display OTEL Collector configuration
      ansible.builtin.debug:
        msg:
          - "OTEL Collector Version: {{ otel_collector_version }}"
          - "Architecture: {{ otel_arch }}"
          - "Destination: {{ otel_host }}"

    - name: Download otelcol-contrib
      ansible.builtin.get_url:
        url: "https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v{{ otel_collector_version }}/otelcol-contrib_{{ otel_collector_version }}_{{ otel_arch }}.tar.gz"
        dest: /tmp/otelcol-contrib.tar.gz
        mode: '0644'

    - name: Extract otelcol-contrib
      ansible.builtin.unarchive:
        src: /tmp/otelcol-contrib.tar.gz
        dest: /tmp
        remote_src: true

    - name: Install otelcol-contrib binary
      ansible.builtin.copy:
        src: /tmp/otelcol-contrib
        dest: /usr/local/bin/otelcol-contrib
        remote_src: true
        mode: '0755'
        owner: root
        group: root
      become: true
      notify: Restart otel-collector

    - name: Create OTEL config directory
      ansible.builtin.file:
        path: /etc/otelcol-contrib
        state: directory
        owner: root
        group: root
        mode: '0755'
      become: true

    - name: Deploy OTEL Collector configuration
      ansible.builtin.template:
        src: otel-collector-config.yaml.j2
        dest: /etc/otelcol-contrib/config.yaml
        owner: root
        group: root
        mode: '0644'
      become: true
      notify: Restart otel-collector

    - name: Deploy OTEL Collector systemd service
      ansible.builtin.template:
        src: otel-collector.service.j2
        dest: /etc/systemd/system/otelcol-contrib.service
        owner: root
        group: root
        mode: '0644'
      become: true
      notify:
        - Reload systemd
        - Restart otel-collector

    - name: Enable and start OTEL Collector service
      ansible.builtin.systemd:
        name: otelcol-contrib
        enabled: true
        state: started
        daemon_reload: true
      become: true

    - name: Clean up OTEL temporary files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/otelcol-contrib.tar.gz
        - /tmp/otelcol-contrib
